# セキュリティメカニズム詳細リファレンス

## 1. メカニズム概要

### 1.1 セキュリティメカニズム一覧

| メカニズム | 正式名称 | 目的 | 暗号技術 |
|-----------|---------|------|----------|
| **PA** | Passive Authentication | データ完全性・真正性 | 署名検証 |
| **AA** | Active Authentication | クローン検出 | チャレンジ-レスポンス |
| **CA** | Chip Authentication | セッション暗号化＋クローン検出 | DH/ECDH |
| **BAC** | Basic Access Control | アクセス制御 | 3DES |
| **PACE** | Password Authenticated Connection Establishment | 安全なアクセス制御 | ECDH |
| **TA** | Terminal Authentication | 端末権限検証 | 証明書チェーン |

### 1.2 メカニズム依存関係

```
┌──────────────────────────────────────────────────────┐
│            ePassport セキュリティスタック            │
└──────────────────────────────────────────────────────┘

Layer 4: 拡張アクセス制御（EAC）
  ┌─────────────────────────────────────────────────┐
  │  TA (Terminal Authentication)                   │
  │  ・読取端末の権限検証                            │
  │  ・DG3（指紋）、DG4（虹彩）へのアクセス許可      │
  └─────────────────────────────────────────────────┘
         │ 前提条件
         ▼
Layer 3: チップ認証
  ┌─────────────────────────────────────────────────┐
  │  CA (Chip Authentication)                       │
  │  または                                          │
  │  AA (Active Authentication)                     │
  │  ・ICチップのクローン検出                        │
  │  ・CAはセッション暗号化も提供                    │
  └─────────────────────────────────────────────────┘
         │ 前提条件
         ▼
Layer 2: アクセス制御
  ┌─────────────────────────────────────────────────┐
  │  PACE (推奨)  または  BAC (レガシー)            │
  │  ・MRZ情報によるアクセス制御                     │
  │  ・盗聴防止のセキュアチャネル確立                │
  └─────────────────────────────────────────────────┘
         │ 前提条件
         ▼
Layer 1: データ認証（常に実行）
  ┌─────────────────────────────────────────────────┐
  │  PA (Passive Authentication)                    │
  │  ・SOD署名検証                                   │
  │  ・データグループハッシュ検証                    │
  │  ・データの完全性・真正性確認                    │
  └─────────────────────────────────────────────────┘
```

## 2. PA（Passive Authentication）

### 2.1 概要

| 項目 | 内容 |
|------|------|
| **目的** | データの完全性と真正性の検証 |
| **検出対象** | データ改ざん |
| **検出不可** | ICチップのクローン |
| **必須度** | 必須 |

### 2.2 暗号技術

| 用途 | 使用技術 |
|------|----------|
| SOD署名 | RSA/ECDSA |
| ハッシュ | SHA-256（推奨） |
| 証明書検証 | X.509 PKI |

### 2.3 検証フロー

```
【PA検証フロー】

Step 1: SODからDSC抽出
  ┌─────────────────────────────────────┐
  │ SOD (CMS SignedData)               │
  │   └── certificates[0] → DSC        │
  └─────────────────────────────────────┘

Step 2: 証明書チェーン検証
  ┌─────────────────────────────────────┐
  │ DSC                                 │
  │   │                                 │
  │   └── 署名検証 ← CSCA公開鍵        │
  └─────────────────────────────────────┘

Step 3: CRL確認
  ┌─────────────────────────────────────┐
  │ DSCシリアル ∉ CRL → 有効           │
  │ DSCシリアル ∈ CRL → 失効           │
  └─────────────────────────────────────┘

Step 4: SOD署名検証
  ┌─────────────────────────────────────┐
  │ SOD.signature                       │
  │   │                                 │
  │   └── 署名検証 ← DSC公開鍵         │
  └─────────────────────────────────────┘

Step 5: データグループハッシュ検証
  ┌─────────────────────────────────────┐
  │ Hash(DG1) == SOD.DG1Hash ?         │
  │ Hash(DG2) == SOD.DG2Hash ?         │
  │ ...                                 │
  └─────────────────────────────────────┘
```

### 2.4 セキュリティ特性

| 特性 | PA |
|------|-----|
| データ完全性 | ✅ |
| データ真正性 | ✅ |
| クローン検出 | ❌ |
| リプレイ攻撃防止 | ❌ |

## 3. AA（Active Authentication）

### 3.1 概要

| 項目 | 内容 |
|------|------|
| **目的** | ICチップの真正性検証（クローン検出） |
| **方式** | チャレンジ-レスポンス |
| **格納データ** | DG15（AA公開鍵） |
| **必須度** | 任意（推奨） |

### 3.2 暗号技術

| 用途 | 使用技術 |
|------|----------|
| チャレンジ署名 | RSA/ECDSA |
| 乱数生成 | TRNG |

### 3.3 プロトコルフロー

```
【AAプロトコル】

┌─────────────┐                    ┌─────────────┐
│  Reader     │                    │  Passport   │
│  (検証者)   │                    │  ICチップ   │
└──────┬──────┘                    └──────┬──────┘
       │                                  │
       │  1. GET CHALLENGE                │
       │ ─────────────────────────────────>│
       │                                  │
       │  2. 8バイト乱数 (RND.IFD)         │
       │ <─────────────────────────────────│
       │                                  │
       │  3. INTERNAL AUTHENTICATE        │
       │     (RND.IFD)                    │
       │ ─────────────────────────────────>│
       │                                  │
       │        ┌──────────────────────┐  │
       │        │ 署名 = Sign(RND.IFD) │  │
       │        │   (AA秘密鍵で)       │  │
       │        └──────────────────────┘  │
       │                                  │
       │  4. 署名レスポンス                │
       │ <─────────────────────────────────│
       │                                  │
  ┌────┴────┐                             │
  │ 署名検証 │                             │
  │ (DG15   │                             │
  │  公開鍵) │                             │
  └────┬────┘                             │
       │                                  │
       ▼                                  │
  認証成功/失敗                           │
```

### 3.4 セキュリティ特性

| 特性 | AA |
|------|-----|
| クローン検出 | ✅ |
| Forward Secrecy | ❌ |
| セッション暗号化 | ❌ |

## 4. CA（Chip Authentication）

### 4.1 概要

| 項目 | 内容 |
|------|------|
| **目的** | クローン検出＋セッション暗号化 |
| **方式** | ECDH鍵合意 |
| **格納データ** | DG14（CA公開鍵） |
| **必須度** | 推奨 |

### 4.2 暗号技術

| 用途 | 使用技術 |
|------|----------|
| 鍵合意 | ECDH（brainpoolP256r1推奨） |
| セッション鍵導出 | KDF（SHA-256ベース） |
| セッション暗号化 | AES-CBC |
| MAC | CMAC-AES |

### 4.3 プロトコルフロー

```
【CAプロトコル（ECDH版）】

┌─────────────┐                    ┌─────────────┐
│  Reader     │                    │  Passport   │
│  (検証者)   │                    │  ICチップ   │
└──────┬──────┘                    └──────┬──────┘
       │                                  │
       │  1. Read DG14                    │
       │ ─────────────────────────────────>│
       │                                  │
       │  2. CA公開鍵 (PK.DH_IC)          │
       │ <─────────────────────────────────│
       │                                  │
  ┌────┴────┐                             │
  │一時鍵生成│                             │
  │SK.DH_IFD│                             │
  │PK.DH_IFD│                             │
  └────┬────┘                             │
       │                                  │
       │  3. MSE:SET AT                   │
       │     (PK.DH_IFD, OID)             │
       │ ─────────────────────────────────>│
       │                                  │
       │        ┌──────────────────────┐  │
       │        │ 共有秘密計算         │  │
       │        │ K = ECDH(SK.IC,      │  │
       │        │         PK.DH_IFD)   │  │
       │        │                      │  │
       │        │ セッション鍵導出     │  │
       │        │ K_enc = KDF(K, 1)   │  │
       │        │ K_mac = KDF(K, 2)   │  │
       │        └──────────────────────┘  │
       │                                  │
       │  4. General Authenticate         │
       │ ─────────────────────────────────>│
       │                                  │
       │  5. 認証トークン                  │
       │ <─────────────────────────────────│
       │                                  │
  ┌────┴────┐                             │
  │共有秘密 │                             │
  │計算     │                             │
  │セッション│                             │
  │鍵導出   │                             │
  └────┬────┘                             │
       │                                  │
       ▼                                  │
  セキュアチャネル確立                    │
```

### 4.4 セキュリティ特性

| 特性 | CA |
|------|-----|
| クローン検出 | ✅ |
| Forward Secrecy | ✅ |
| セッション暗号化 | ✅ |

## 5. BAC（Basic Access Control）

### 5.1 概要

| 項目 | 内容 |
|------|------|
| **目的** | MRZ情報によるアクセス制御 |
| **方式** | 共有秘密ベースの認証 |
| **入力** | MRZ（文書番号、生年月日、有効期限） |
| **必須度** | 必須（PACEがない場合） |

### 5.2 暗号技術

| 用途 | 使用技術 |
|------|----------|
| 鍵導出 | SHA-1 |
| 暗号化 | 3DES-CBC |
| MAC | Retail MAC (ISO 9797-1 Alg 3) |

### 5.3 鍵導出

```
【BAC鍵導出手順】

Input: MRZ情報
  ・文書番号（9文字）+ チェックデジット
  ・生年月日（6桁）+ チェックデジット
  ・有効期限（6桁）+ チェックデジット

Step 1: MRZ情報の結合
  MRZ_info = 文書番号||CD || 生年月日||CD || 有効期限||CD

Step 2: シードの計算
  K_seed = SHA-1(MRZ_info)[0:16]  // 先頭16バイト

Step 3: 派生鍵の生成
  K_enc = KDF(K_seed, 1)  // 暗号化鍵
  K_mac = KDF(K_seed, 2)  // MAC鍵

  KDF(K, c) = SHA-1(K || 00000001)[0:16]  // c=1の場合
            = SHA-1(K || 00000002)[0:16]  // c=2の場合

Step 4: 3DES鍵への変換
  K_enc → 24バイト3DES鍵（パリティ調整）
  K_mac → 24バイト3DES鍵（パリティ調整）
```

### 5.4 プロトコルフロー

```
【BACプロトコル】

┌─────────────┐                    ┌─────────────┐
│  Reader     │                    │  Passport   │
│  (検証者)   │                    │  ICチップ   │
└──────┬──────┘                    └──────┬──────┘
       │                                  │
       │  1. GET CHALLENGE                │
       │ ─────────────────────────────────>│
       │                                  │
       │  2. RND.IC (8バイト乱数)          │
       │ <─────────────────────────────────│
       │                                  │
  ┌────┴────┐                             │
  │乱数生成 │                             │
  │RND.IFD │                             │
  │K.IFD   │                             │
  └────┬────┘                             │
       │                                  │
       │  3. EXTERNAL AUTHENTICATE        │
       │     E_IFD = Enc(RND.IFD||RND.IC||K.IFD)
       │     M_IFD = MAC(E_IFD)           │
       │ ─────────────────────────────────>│
       │                                  │
       │        ┌──────────────────────┐  │
       │        │ 復号・検証           │  │
       │        │ RND.IC一致確認       │  │
       │        │                      │  │
       │        │ 乱数生成 K.IC        │  │
       │        │ E_IC = Enc(...)      │  │
       │        │ M_IC = MAC(E_IC)     │  │
       │        └──────────────────────┘  │
       │                                  │
       │  4. E_IC || M_IC                 │
       │ <─────────────────────────────────│
       │                                  │
  ┌────┴────┐                             │
  │復号・検証│                             │
  │RND.IFD  │                             │
  │一致確認 │                             │
  │         │                             │
  │セッション│                             │
  │鍵計算   │                             │
  │KS = K.IFD XOR K.IC                   │
  └────┬────┘                             │
       │                                  │
       ▼                                  │
  セキュアチャネル確立                    │
```

### 5.5 セキュリティ特性

| 特性 | BAC |
|------|-----|
| アクセス制御 | ✅ |
| Forward Secrecy | ❌ |
| 辞書攻撃耐性 | 低（MRZエントロピー依存） |

## 6. PACE（Password Authenticated Connection Establishment）

### 6.1 概要

| 項目 | 内容 |
|------|------|
| **目的** | 安全なアクセス制御（BAC後継） |
| **方式** | パスワードベースのECDH |
| **入力** | MRZ、CAN、または PIN |
| **必須度** | 推奨（2024年以降の新規発行） |

### 6.2 暗号技術

| 用途 | 使用技術 |
|------|----------|
| 鍵合意 | ECDH（Generic Mapping/Integrated Mapping） |
| 暗号化 | AES-CBC |
| MAC | CMAC-AES |
| ハッシュ | SHA-256 |

### 6.3 PACE vs BAC

| 特性 | PACE | BAC |
|------|------|-----|
| Forward Secrecy | ✅ | ❌ |
| 辞書攻撃耐性 | 高 | 低 |
| 暗号化 | AES | 3DES |
| エントロピー | 可変（CAN/PIN） | MRZ固定 |

### 6.4 簡略プロトコルフロー

```
【PACEプロトコル概要】

1. ICチップから暗号化された乱数を取得
2. MRZ/CAN/PINから鍵を導出し乱数を復号
3. 復号した乱数でドメインパラメータをマッピング
4. マッピングされたドメインでECDH鍵合意
5. セッション鍵導出
6. 認証トークン交換
```

### 6.5 セキュリティ特性

| 特性 | PACE |
|------|------|
| アクセス制御 | ✅ |
| Forward Secrecy | ✅ |
| 辞書攻撃耐性 | 高 |
| 量子耐性 | ❌（ECDH） |

## 7. TA（Terminal Authentication）

### 7.1 概要

| 項目 | 内容 |
|------|------|
| **目的** | 読取端末の権限検証 |
| **用途** | DG3（指紋）、DG4（虹彩）へのアクセス |
| **必須度** | EAC使用時は必須 |

### 7.2 証明書チェーン

```
【TA証明書チェーン】

CVCA（Country Verifying CA）
  │
  └── DVCA（Document Verifying CA）
        │
        └── IS証明書（Inspection System）
              │
              └── 読取端末
```

### 7.3 権限レベル

| 権限 | アクセス可能DG | 用途 |
|------|---------------|------|
| なし | DG1, DG2 | 一般確認 |
| DG3 | DG1, DG2, DG3 | 指紋照合 |
| DG4 | DG1, DG2, DG4 | 虹彩照合 |
| Full | 全DG | 法執行機関 |

## 8. セキュアメッセージング（SM）

### 8.1 概要

BAC/PACE/CA成功後のすべての通信は暗号化されます。

### 8.2 APDUフォーマット

```
【セキュアメッセージング APDU構造】

平文APDU:
  CLA | INS | P1 | P2 | [Lc] | [Data] | [Le]

SM APDU:
  CLA' | INS | P1 | P2 | Lc' | DO'87 | DO'97 | DO'8E | Le'

DO'87: 暗号化データ（パディング含む）
DO'97: 暗号化されたLeフィールド
DO'8E: MAC（暗号化データのMAC）
```

### 8.3 暗号化方式

| プロトコル | 暗号化 | MAC |
|-----------|--------|-----|
| BAC | 3DES-CBC | Retail MAC |
| PACE | AES-CBC | CMAC-AES |
| CA | AES-CBC | CMAC-AES |

---

**関連ドキュメント**:
- [CRYPTOGRAPHIC-ALGORITHMS.md](CRYPTOGRAPHIC-ALGORITHMS.md) - 使用アルゴリズム詳細
- [PKI-INFRASTRUCTURE.md](PKI-INFRASTRUCTURE.md) - PA用PKI構造
- [GLOSSARY.md](GLOSSARY.md) - 用語定義
