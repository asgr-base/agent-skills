# ISO 14443 NFC通信 詳細リファレンス

## 1. 概要

### 1.1 ISO 14443シリーズ

| Part | 内容 |
|------|------|
| **14443-1** | 物理特性 |
| **14443-2** | 無線周波数インターフェース |
| **14443-3** | 初期化・衝突回避 |
| **14443-4** | 伝送プロトコル |

### 1.2 NFC（Near Field Communication）

| 項目 | 内容 |
|------|------|
| **周波数** | 13.56 MHz |
| **通信距離** | 最大10cm（通常1-4cm） |
| **適用範囲** | ePassport、交通系IC、決済、入退室等 |

## 2. Type AとType B

### 2.1 Type A vs Type B

| 項目 | Type A | Type B |
|------|--------|--------|
| **変調方式** | ASK 100% | ASK 10% |
| **ビットコーディング** | Modified Miller | NRZ-L |
| **フレーミング** | Start/Stop bit | SOF/EOF |
| **衝突回避** | ビットフレーム衝突回避 | スロットマーカー |
| **初期ビットレート** | 106 kbps | 106 kbps |
| **代表例** | MIFARE、FeliCa（互換） | ePassport、運転免許証 |

### 2.2 ePassportの選択

ICAO 9303ではType AまたはType Bの使用を許可。多くの国はType Bを採用。

## 3. 通信フロー

### 3.1 全体フロー

```
┌─────────────┐                    ┌─────────────┐
│   Reader    │                    │    Card     │
│   (PCD)     │                    │   (PICC)    │
└──────┬──────┘                    └──────┬──────┘
       │                                  │
       │  【Layer 2: RF Interface】       │
       │  REQA/REQB (ポーリング)          │
       │ ─────────────────────────────────>│
       │                                  │
       │  ATQA/ATQB (応答)                │
       │ <─────────────────────────────────│
       │                                  │
       │  【Layer 3: Initialization】     │
       │  Anticollision / SELECT          │
       │ ─────────────────────────────────>│
       │                                  │
       │  UID / ATS                       │
       │ <─────────────────────────────────│
       │                                  │
       │  【Layer 4: Protocol】           │
       │  I-Block (APDU)                  │
       │ ←────────────────────────────────→│
       │                                  │
```

### 3.2 ポーリングとカード検出

```
【Type Aフロー】

1. REQA (0x26) 送信
2. ATQA (2バイト) 受信
3. Anticollision Loop
   - SELECT (0x93/0x95/0x97)
   - UID取得
4. SAK受信
5. RATS送信（ISO 14443-4対応確認）
6. ATS受信

【Type Bフロー】

1. REQB (0x05) 送信
2. ATQB (12バイト以上) 受信
   - PUPI (4バイト)
   - Application Data (4バイト)
   - Protocol Info (3バイト)
3. ATTRIB送信
4. Answer to ATTRIB受信
```

## 4. フレーム構造

### 4.1 Type Aフレーム

```
【Short Frame（REQA/WUPA）】
7ビット + パリティなし

【Standard Frame】
┌──────┬──────────────┬────────┬──────┐
│ SOC  │    Data      │ Parity │ EOC  │
└──────┴──────────────┴────────┴──────┘

SOC: Start of Communication
EOC: End of Communication
```

### 4.2 Type Bフレーム

```
【Type Bフレーム】
┌──────┬──────────────┬──────┬──────┐
│ SOF  │    Data      │ CRC  │ EOF  │
└──────┴──────────────┴──────┴──────┘

SOF: 10 etu Low + 2 etu High
EOF: 10 etu Low
CRC: CRC-16 (ISO 13239)
```

## 5. ISO 14443-4プロトコル

### 5.1 ブロック構造

```
┌─────────┬─────────────┬──────────┬──────┐
│ Prologue│    INF      │ Epilogue │      │
│  Field  │  (APDU)     │  Field   │      │
├─────────┼─────────────┼──────────┤      │
│ PCB NAD │    Data     │ CRC/EDC  │      │
│  (CID)  │             │          │      │
└─────────┴─────────────┴──────────┴──────┘
```

### 5.2 ブロックタイプ

| タイプ | PCB | 用途 |
|--------|-----|------|
| **I-Block** | 0x0X | 情報ブロック（APDU転送） |
| **R-Block** | 0xAX/0xBX | ACK/NAK |
| **S-Block** | 0xCX | 監督ブロック（WTX等） |

### 5.3 PCB（Protocol Control Byte）

```
【I-Block PCB】
┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│  0  │  0  │  0  │  0  │ CID │ NAD │  1  │ Blk │
└─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘

CID: Card Identifier付加
NAD: Node Address付加
Blk: ブロック番号（0/1交互）

【R-Block PCB】
┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│  1  │  0  │  1  │  0  │ CID │  X  │  1  │ Blk │
└─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘

X: 0=ACK, 1=NAK

【S-Block PCB】
┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│  1  │  1  │ K1  │ K0  │ CID │  X  │  1  │  X  │
└─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘

K1K0: 00=DESELECT, 11=WTX
```

## 6. ビットレート

### 6.1 サポートビットレート

| ビットレート | DS/DR値 | 備考 |
|-------------|---------|------|
| **106 kbps** | fc/128 | 必須（デフォルト） |
| **212 kbps** | fc/64 | オプション |
| **424 kbps** | fc/32 | オプション |
| **848 kbps** | fc/16 | オプション |

### 6.2 ePassport要件

ICAO 9303では最低424 kbps対応を推奨。

## 7. ATS（Answer To Select）

### 7.1 ATS構造

```
┌─────┬──────┬──────┬──────┬─────────────────┐
│ TL  │  T0  │ TA1  │ TB1  │ Historical Bytes│
└─────┴──────┴──────┴──────┴─────────────────┘

TL: ATS長
T0: フォーマットバイト
TA1: インターフェースバイトA（ビットレート）
TB1: インターフェースバイトB（FWI, SFGI）
TC1: インターフェースバイトC（プロトコルオプション）
```

### 7.2 T0バイト

```
┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│  0  │ TC1 │ TB1 │ TA1 │      FSCI         │
└─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘

TC1/TB1/TA1: 対応するバイトの存在
FSCI: フレームサイズ（0-8）
```

### 7.3 FSCI（Frame Size）

| FSCI | 最大フレームサイズ |
|------|------------------|
| 0 | 16バイト |
| 1 | 24バイト |
| 2 | 32バイト |
| 3 | 40バイト |
| 4 | 48バイト |
| 5 | 64バイト |
| 6 | 96バイト |
| 7 | 128バイト |
| 8 | 256バイト |

## 8. タイミング

### 8.1 Frame Waiting Time（FWT）

```
FWT = (256 × 16 / fc) × 2^FWI

fc = 13.56 MHz
FWI = 0-14（デフォルト4）

FWI=4: FWT ≈ 4.8ms
FWI=8: FWT ≈ 77ms
```

### 8.2 Waiting Time Extension（WTX）

カードが処理に時間がかかる場合、S(WTX)ブロックでタイムアウト延長を要求。

```
【WTX要求】
PCD → PICC: I-Block (APDU)
PICC → PCD: S(WTX) request (wtxm=10)
PCD → PICC: S(WTX) response
... (処理継続) ...
PICC → PCD: I-Block (Response)
```

## 9. ePassport固有仕様

### 9.1 アンテナ配置

| ドキュメント | アンテナ位置 |
|-------------|-------------|
| TD3（パスポート） | 表紙またはデータページ |
| TD1（カード） | カード内 |
| TD2（カード） | カード内 |

### 9.2 EMD（Electromagnetic Disturbance）

ICAO 9303 Part 10では、電磁妨害への耐性を規定。

### 9.3 動作温度

| 条件 | 範囲 |
|------|------|
| **動作温度** | -10°C ～ +50°C |
| **保存温度** | -35°C ～ +80°C |

## 10. トラブルシューティング

### 10.1 通信問題

| 症状 | 原因 | 対策 |
|------|------|------|
| カード検出不可 | 距離/角度 | リーダーとの距離・角度調整 |
| 通信途切れ | RF干渉 | 金属・他カード除去 |
| タイムアウト | FWT超過 | WTX処理確認 |
| CRCエラー | ノイズ | 環境確認、リトライ |

### 10.2 ビットレート問題

| 症状 | 原因 | 対策 |
|------|------|------|
| 高速通信失敗 | カード未対応 | 106kbpsにフォールバック |
| 不安定 | RF品質 | ビットレート下げ |

## 11. リーダー選定

### 11.1 主要NFC ICチップ

| メーカー | チップ | 特徴 |
|---------|--------|------|
| NXP | PN532 | 汎用、低価格 |
| NXP | PN5180 | 高性能、EMD対応 |
| ST | ST25R3911B | 高性能、低消費電力 |
| ACS | ACR122U | USB接続リーダー |

### 11.2 ePassport対応要件

- ISO 14443-4対応
- Type A/B両対応推奨
- 424 kbps以上推奨
- セキュアメッセージング対応

---

**関連ドキュメント**:
- [SMARTCARD-APDU-GUIDE.md](SMARTCARD-APDU-GUIDE.md) - 上位層APDU
- [SECURITY-MECHANISMS.md](SECURITY-MECHANISMS.md) - BAC/PACE
- [GLOSSARY.md](GLOSSARY.md) - 用語定義
