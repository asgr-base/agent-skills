# ISO 7816-4 APDU 詳細リファレンス

## 1. 概要

### 1.1 ISO 7816シリーズ

| Part | 内容 |
|------|------|
| **7816-1** | 物理特性 |
| **7816-2** | 端子配置 |
| **7816-3** | 電気インターフェース |
| **7816-4** | コマンド・レスポンス（本ガイド） |
| **7816-5** | アプリケーション識別子（AID） |
| **7816-8** | セキュリティコマンド |

### 1.2 APDUとは

| 項目 | 内容 |
|------|------|
| **正式名称** | Application Protocol Data Unit |
| **用途** | ICカードとの通信プロトコル |
| **適用範囲** | ePassport、マイナンバー、クレジットカード、SIM等 |

## 2. APDU構造

### 2.1 コマンドAPDU（C-APDU）

```
┌─────┬─────┬─────┬─────┬──────┬──────────┬──────┐
│ CLA │ INS │ P1  │ P2  │ [Lc] │  [Data]  │ [Le] │
└─────┴─────┴─────┴─────┴──────┴──────────┴──────┘
  必須   必須  必須  必須   任意     任意      任意
```

| フィールド | サイズ | 説明 |
|-----------|--------|------|
| **CLA** | 1バイト | クラスバイト |
| **INS** | 1バイト | 命令バイト |
| **P1** | 1バイト | パラメータ1 |
| **P2** | 1バイト | パラメータ2 |
| **Lc** | 0/1/3バイト | データ長 |
| **Data** | Lcバイト | コマンドデータ |
| **Le** | 0/1/2/3バイト | 期待応答長 |

### 2.2 レスポンスAPDU（R-APDU）

```
┌──────────────────┬──────┬──────┐
│      Data        │ SW1  │ SW2  │
└──────────────────┴──────┴──────┘
       任意          必須   必須
```

| フィールド | サイズ | 説明 |
|-----------|--------|------|
| **Data** | 可変 | 応答データ |
| **SW1** | 1バイト | ステータスワード1 |
| **SW2** | 1バイト | ステータスワード2 |

### 2.3 APDUケース

| ケース | Lc | Data | Le | 説明 |
|--------|----|----|------|-----|
| **Case 1** | なし | なし | なし | コマンドのみ |
| **Case 2** | なし | なし | あり | データ要求 |
| **Case 3** | あり | あり | なし | データ送信 |
| **Case 4** | あり | あり | あり | データ送受信 |

## 3. CLAバイト

### 3.1 CLA構造

```
┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│ b8  │ b7  │ b6  │ b5  │ b4  │ b3  │ b2  │ b1  │
└─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘

b8-b5: プロプライエタリ識別
b4: セキュアメッセージング（SM）
b3-b2: 論理チャネル
b1: 予約
```

### 3.2 主要CLA値

| CLA | 説明 |
|-----|------|
| 0x00 | ISO標準、SMなし |
| 0x0C | ISO標準、SM（コマンドヘッダ認証なし） |
| 0x80-0x8F | プロプライエタリ |
| 0x90-0x9F | プロプライエタリ |

## 4. 主要コマンド

### 4.1 ファイル選択・読取

#### SELECT（A4）

| 項目 | 値 |
|------|-----|
| **INS** | 0xA4 |
| **P1** | 選択方法 |
| **P2** | オプション |

| P1 | 選択方法 |
|----|---------|
| 0x00 | MF、DF、EFをFIDで選択 |
| 0x01 | 子DFをFIDで選択 |
| 0x02 | 親DFのEFを選択 |
| 0x03 | 親DFを選択 |
| 0x04 | DFをDF名（AID）で選択 |

```
【SELECT例：AIDでアプリケーション選択】

00 A4 04 00 07 A0 00 00 02 47 10 01
│  │  │  │  │  └───────────────────┘
│  │  │  │  │         AID (7バイト)
│  │  │  │  └── Lc = 7
│  │  │  └── P2 = 00
│  │  └── P1 = 04 (DF名で選択)
│  └── INS = A4 (SELECT)
└── CLA = 00
```

#### READ BINARY（B0）

| 項目 | 値 |
|------|-----|
| **INS** | 0xB0 |
| **P1-P2** | オフセット |
| **Le** | 読取バイト数 |

```
【READ BINARY例：先頭256バイト読取】

00 B0 00 00 00
│  │  │  │  └── Le = 00 (256バイト)
│  │  └──┴── オフセット = 0
│  └── INS = B0 (READ BINARY)
└── CLA = 00
```

### 4.2 認証コマンド

#### GET CHALLENGE（84）

| 項目 | 値 |
|------|-----|
| **INS** | 0x84 |
| **P1-P2** | 0x0000 |
| **Le** | 乱数長（通常8バイト） |

```
【GET CHALLENGE例】

00 84 00 00 08
│  │  │  │  └── Le = 8 (8バイト乱数要求)
│  │  └──┴── P1-P2 = 0000
│  └── INS = 84 (GET CHALLENGE)
└── CLA = 00
```

#### INTERNAL AUTHENTICATE（88）

| 項目 | 値 |
|------|-----|
| **INS** | 0x88 |
| **P1** | アルゴリズム参照 |
| **P2** | 鍵参照 |

#### EXTERNAL AUTHENTICATE（82）

| 項目 | 値 |
|------|-----|
| **INS** | 0x82 |
| **P1** | アルゴリズム参照 |
| **P2** | 鍵参照 |

### 4.3 セキュリティコマンド

#### MANAGE SECURITY ENVIRONMENT（22）

| 項目 | 値 |
|------|-----|
| **INS** | 0x22 |
| **P1** | 操作モード |
| **P2** | 設定対象 |

| P1 | 操作 |
|----|------|
| 0x41 | SET (Chip Authentication) |
| 0xC1 | RESTORE + SET |
| 0x81 | VERIFY |

#### GENERAL AUTHENTICATE（86/87）

| 項目 | 値 |
|------|-----|
| **INS** | 0x86 または 0x87 |
| **用途** | PACE、CA等のチャレンジ・レスポンス |

## 5. ステータスワード（SW1-SW2）

### 5.1 成功

| SW | 意味 |
|----|------|
| 9000 | 正常終了 |
| 61XX | 応答データあり（XXバイト）、GET RESPONSEで取得 |

### 5.2 警告

| SW | 意味 |
|----|------|
| 6282 | ファイル終端到達（End of file） |
| 6283 | 選択ファイル無効化済み |
| 62XX | 不揮発性メモリ変更なしの警告 |
| 63CX | 照合失敗（残り試行回数X回） |

### 5.3 エラー

| SW | 意味 |
|----|------|
| 6700 | 不正な長さ（Lc/Le） |
| 6981 | コマンドと互換性のないファイル構造 |
| 6982 | セキュリティ条件不満足 |
| 6983 | 認証方法ブロック済み |
| 6984 | 参照データ無効化済み |
| 6985 | 使用条件不満足 |
| 6986 | コマンド許可されず（カレントEFなし） |
| 6A80 | データフィールドパラメータ不正 |
| 6A81 | 機能未サポート |
| 6A82 | ファイル未発見 |
| 6A83 | レコード未発見 |
| 6A86 | P1-P2不正 |
| 6A88 | 参照データ未発見 |
| 6B00 | オフセット範囲外 |
| 6CXX | 不正なLe（正しいLeはXX） |
| 6D00 | 不正なINS |
| 6E00 | 不正なCLA |
| 6F00 | 不明エラー |

## 6. ファイル構造

### 6.1 ファイル階層

```
MF（Master File）
 │
 ├── DF（Dedicated File = アプリケーション）
 │    │
 │    ├── EF（Elementary File = データ）
 │    ├── EF
 │    └── DF（サブアプリケーション）
 │         └── EF
 │
 └── EF（MF直下のデータ）
```

### 6.2 ファイル識別子（FID）

| FID | 説明 |
|-----|------|
| 0x3F00 | MF（Master File） |
| 0x2F00-0x2FFF | MF直下のEF |
| 0x7F00-0x7FFF | DF（アプリケーション） |
| 0x0001-0x001F | 内部EF |

### 6.3 EFタイプ

| タイプ | 説明 |
|--------|------|
| **Transparent** | バイナリファイル（READ BINARY使用） |
| **Linear Fixed** | 固定長レコード |
| **Linear Variable** | 可変長レコード |
| **Cyclic** | 循環バッファ |

## 7. セキュアメッセージング（SM）

### 7.1 SM-APDU構造

```
【SM適用後のAPDU】

CLA' | INS | P1 | P2 | Lc' | DO'87 | DO'97 | DO'8E | Le'

DO'87: 暗号化コマンドデータ
DO'97: 暗号化Le
DO'8E: MAC
```

### 7.2 SMタグ

| タグ | 説明 |
|------|------|
| 0x87 | パディング付き暗号化データ |
| 0x85 | パディングなし暗号化データ |
| 0x97 | 暗号化Le |
| 0x8E | MAC（暗号チェックサム） |
| 0x99 | 処理ステータス |

## 8. ePassport固有コマンド

### 8.1 ePassport AID

```
AID: A0 00 00 02 47 10 01 (LDS1)
     A0 00 00 02 47 20 01 (Travel Records)
     A0 00 00 02 47 20 02 (Visa Records)
     A0 00 00 02 47 20 03 (Additional Biometrics)
```

### 8.2 データグループ読取

| DG | SFI | FID | 内容 |
|----|-----|-----|------|
| DG1 | 0x01 | 0x0101 | MRZ情報 |
| DG2 | 0x02 | 0x0102 | 顔画像 |
| DG14 | 0x0E | 0x010E | CA公開鍵 |
| DG15 | 0x0F | 0x010F | AA公開鍵 |
| EF.COM | 0x1E | 0x011E | 共通データ |
| EF.SOD | 0x1D | 0x011D | セキュリティオブジェクト |

```
【DG1読取例】

1. SELECT EF.DG1
   00 A4 02 0C 02 01 01

2. READ BINARY（先頭256バイト）
   00 B0 00 00 00
```

## 9. トラブルシューティング

| 症状 | 原因 | 対策 |
|------|------|------|
| 6982 | アクセス制御 | BAC/PACE実行後に再試行 |
| 6A82 | ファイル未発見 | 正しいFID/AID確認 |
| 6700 | 長さ不正 | Lc/Le見直し |
| 6B00 | オフセット超過 | ファイルサイズ確認 |
| 61XX | 残りデータあり | GET RESPONSEで取得 |

---

**関連ドキュメント**:
- [ASN1-TLV-GUIDE.md](ASN1-TLV-GUIDE.md) - APDUデータのTLV構造
- [NFC-ISO14443-GUIDE.md](NFC-ISO14443-GUIDE.md) - 下位層通信
- [SECURITY-MECHANISMS.md](SECURITY-MECHANISMS.md) - BAC/PACE/CA
